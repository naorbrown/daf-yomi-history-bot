name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install linters
        run: pip install ruff

      - name: Check code style
        run: ruff check .

      - name: Check formatting
        run: ruff format --check .

  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov pyyaml

      - name: Run tests
        run: pytest tests/ -v --tb=short --cov=src --cov-report=term-missing

  validate:
    name: Validate
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Validate Python syntax
        run: |
          python -m py_compile send_video.py
          python -m py_compile scripts/poll_commands.py
          for f in src/*.py; do
            python -m py_compile "$f"
          done
          echo "All Python files have valid syntax"

      - name: Validate workflow YAML
        run: |
          pip install pyyaml
          for f in .github/workflows/*.yml; do
            python -c "import yaml; yaml.safe_load(open('$f'))"
          done
          echo "All workflow files are valid YAML"

      - name: Check required files
        run: |
          files=(
            "send_video.py"
            "scripts/poll_commands.py"
            "requirements.txt"
            ".github/workflows/daily_video.yml"
            ".github/workflows/poll-commands.yml"
          )
          for f in "${files[@]}"; do
            test -f "$f" || { echo "Missing: $f"; exit 1; }
          done
          echo "All required files exist"
